// m_sword.c

#include <ansi.h>
#include <weapon.h>

//inherit M_WEAPON;
inherit S_WEAPON;

int duanlian(object weapon);
int do_hui(object weapon);


string query_autoload() { return 1 + ""; }	//autoload weapon

void init()
{
	add_action("do_duanlian","duanlian");
	add_action("do_hui","hui");
}


void create()
{
	object me;
	string w_name,w_id,w_or,p_name,name;
	int w_lv,dj,color;
	me = this_player();
//¶ÁÈëÊý¾Ý
//×ÔÖÆÎäÆ÷±»ËûÈËµÃµ½ºóÓÐbug£¬¼ÓÈëÒÔÏÂÓï¾ä¿ÉÒÔ½â¾ö¡£
/*        if (!(me->query("weapon/name")))
{
                remove_call_out("destrory");
                call_out("destrory",1,me);
                return;
}*/
	w_name=me->query("weapon/name");
	w_id = "my "+me->query("weapon/id");
	w_or = me->query("weapon/or");
	w_lv = me->query("weapon/lv");
	dj = me->query("weapon/dj");
        color = w_lv / 2;

	p_name = HIY"·²Æ·"NOR;

	if (me->query("weapon/pin"))
	{
		p_name = me->query("weapon/pin");
	}
        switch(color){
                case 1:
                        name = WHT + p_name + w_name + NOR;
                        break;
                case 2:
                        name = HIR + p_name + w_name + NOR;
                        break;
                case 3:
                case 4:
                        name = HIB + p_name + w_name + NOR;
                        break;
                case 5:
                        name = HIY + p_name + w_name + NOR;
                        break;
                case 6:
                        name = HIM + p_name + w_name + NOR;
                        break;
                case 7:
                        name = MAG + p_name + w_name + NOR;
                        break;
                case 8:
                        name = HIW + p_name + w_name + NOR;
                        break;
                case 9:
                        name = HIC + p_name + w_name + NOR;
                        break;
                default:
                        name = HIG + p_name + w_name + NOR;
                        break;
        }
	if (!me->query("weapon/name"))
	{
		w_name="×ÔÖÆµÄ³¤½£";
	}
	if (!me->query("weapon/id"))
	{
		w_id="sword";
	}
	if (!me->query("weapon/or"))
	{
		w_or="Ç§ÄêÉñÄ¾";
	}
	if (!me->query("weapon/lv"))
	{
		w_lv=5;
	}
	if (!me->query("weapon/dj"))
	{
		dj=1;
	}
	/*if (me->query("weapon/lv",1) > 150)
	{
		w_lv=150;
	}*/

	set_name(name , ({w_id}));
	set("unit", "¿Ú");
	set("weapon_prop/baoji", w_lv * 2);
	set("weapon_prop/yuanshen", me->query("yuanshen/weapon"));
	set("pin",me->query("weapon/pin"));
	set("value",1000);
	set("ownmake",1);
	set("no_sell",1);
	set("no_give",1);
	set("no_get",1);

	set("no_drop",1);
	set("no_get",1);

	set("no_put",1);
	set_desc(w_lv,w_or,w_name);
	switch(w_or)
		{
		case "Ç§ÄêÉñÄ¾" :
			set_weight(500);
			set("material", "iron");
			break;
		case "º£µ×½ðÄ¸" :
			set_weight(1000);
			set("material", "steel");
			break;
		case "º®Ë¿ÓðÖñ" :
			set_weight(30);
			set("material", "bamboo");
			break;
		default :
		}
	if( me->query("weapon/wield_msg"))
		set("wield_msg", me->query("weapon/wield_msg")+"\n");
	else
		set("wield_msg", "$NÍùÑüÖÐÒ»´ø£¬³é³öÁËÒ»¿Ú"+name+"ÎÕÔÚÊÖÖÐ¡£\n");
	if( me->query("weapon/unwield_msg"))
		set("unwield_msg", me->query("weapon/unwield_msg")+"\n");
	else
		set("unwield_msg", "$NÊÖÖÐ"+name+"Ó­·çÒ»¶¶£¬Õ£ÑÛ¼äÒÑÈ»²»¼ûÓ°×Ù¡£\n");
	if (!me->query("weapon/pin"))
		init_sword(w_lv * 10 *dj);
	else if (me->query("weapon/pin") == "ÖÐÆ·")
		init_sword(w_lv * 15 *dj);
	else if (me->query("weapon/pin") == "ÉÏÆ·")
		init_sword(w_lv * 18 *dj);
	else if (me->query("weapon/pin") == "ÉñÆ÷")
		init_sword(w_lv * 21 *dj);
	else if (me->query("weapon/pin") == "ÌìÆ÷")
		init_sword(w_lv * 22 *dj);
	else if (me->query("weapon/pin") == "µØÆ÷")
		init_sword(w_lv * 23 *dj);	
	else if (me->query("weapon/pin") == "ÐþÆ÷")
		init_sword(w_lv * 24 *dj);
	else if (me->query("weapon/pin") == "ÁéÆ÷")
		init_sword(w_lv * 25 *dj);
	else if (me->query("weapon/pin") == "Ú¤Æ÷")
		init_sword(w_lv * 26 *dj);
	else if (me->query("weapon/pin") == "Ê¥Æ÷")
		init_sword(w_lv * 27 *dj);
	else if (me->query("weapon/pin") == "±¦Æ÷")
		init_sword(w_lv * 28 *dj);		
	else if (me->query("weapon/pin") == "Ä§Æ÷")
		init_sword(w_lv * 29 *dj);		
	else if (me->query("weapon/pin") == "ÏÉÆ÷")
		init_sword(w_lv * 30 *dj);		
	else if (me->query("weapon/pin") == "ÐØÆ÷")
		init_sword(w_lv * 31 *dj);		
	else if (me->query("weapon/pin") == "Ò»½×¹íÆ÷")
		init_sword(w_lv * 32 *dj);			
else if (me->query("weapon/pin") == "¶þ½×¹íÆ÷")
		init_sword(w_lv * 33 *dj);			
else if (me->query("weapon/pin") == "Èý½×¹íÆ÷")
		init_sword(w_lv * 34 *dj);			
else if (me->query("weapon/pin") == "ËÄ½×¹íÆ÷")
		init_sword(w_lv * 35 *dj);			
else if (me->query("weapon/pin") == "Îå½×¹íÆ÷")
		init_sword(w_lv * 36 *dj);		
else if (me->query("weapon/pin") == "Ò»½×ÔáÆ÷")
		init_sword(w_lv * 37 *dj);	
else if (me->query("weapon/pin") == "¶þ½×ÔáÆ÷")
		init_sword(w_lv * 38 *dj);	
else if (me->query("weapon/pin") == "Èý½×ÔáÆ÷")
		init_sword(w_lv * 39 *dj);	
else if (me->query("weapon/pin") == "ËÄ½×ÔáÆ÷")
		init_sword(w_lv * 40 *dj);	
else if (me->query("weapon/pin") == "Îå½×ÔáÆ÷")
		init_sword(w_lv * 41 *dj);		
else if (me->query("weapon/pin") == "Áù½×ÔáÆ÷")
		init_sword(w_lv * 42 *dj);		
else if (me->query("weapon/pin") == "Æß½×ÔáÆ÷")
		init_sword(w_lv * 43 *dj);	
else if (me->query("weapon/pin") == "°Ë½×ÔáÆ÷")
		init_sword(w_lv * 44 *dj);	
else if (me->query("weapon/pin") == "¾Å½×ÔáÆ÷")
		init_sword(w_lv * 45 *dj);	
else if (me->query("weapon/pin") == "Ê®½×ÔáÆ÷")
		init_sword(w_lv * 46 *dj);		
else if (me->query("weapon/pin") == "Ò»½×»ÄÆ÷")
		init_sword(w_lv * 47 *dj);			
else if (me->query("weapon/pin") == "¶þ½×»ÄÆ÷")
		init_sword(w_lv * 48 *dj);			
else if (me->query("weapon/pin") == "Èý½×»ÄÆ÷")
		init_sword(w_lv * 49 *dj);			
else if (me->query("weapon/pin") == "ËÄ½×»ÄÆ÷")
		init_sword(w_lv * 50 *dj);			
else if (me->query("weapon/pin") == "Îå½×»ÄÆ÷")
		init_sword(w_lv * 51 *dj);			
else if (me->query("weapon/pin") == "Áù½×»ÄÆ÷")
		init_sword(w_lv * 52 *dj);			
else if (me->query("weapon/pin") == "Æß½×»ÄÆ÷")
		init_sword(w_lv * 53 *dj);			
else if (me->query("weapon/pin") == "°Ë½×»ÄÆ÷")
		init_sword(w_lv * 54 *dj);		
else if (me->query("weapon/pin") == "¾Å½×»ÄÆ÷")
		init_sword(w_lv * 55 *dj);		
else if (me->query("weapon/pin") == "Ê®½×»ÄÆ÷")
		init_sword(w_lv * 56 *dj);			
else if (me->query("weapon/pin") == "ê»ÌìÒ»½×")
		init_sword(w_lv * 57 *dj);				
else if (me->query("weapon/pin") == "ê»Ìì¶þ½×")
		init_sword(w_lv * 58 *dj);					
else if (me->query("weapon/pin") == "ê»ÌìÈý½×")
		init_sword(w_lv * 59 *dj);					
else if (me->query("weapon/pin") == "ê»ÌìËÄ½×")
		init_sword(w_lv * 60 *dj);					
else if (me->query("weapon/pin") == "ê»ÌìÎå½×")
		init_sword(w_lv * 61 *dj);					
else if (me->query("weapon/pin") == "ê»ÌìÁù½×")
		init_sword(w_lv * 62 *dj);				
else if (me->query("weapon/pin") == "ê»ÌìÆß½×")
		init_sword(w_lv * 63 *dj);				
else if (me->query("weapon/pin") == "ê»Ìì°Ë½×")
		init_sword(w_lv * 64 *dj);				
else if (me->query("weapon/pin") == "ê»Ìì¾Å½×")
		init_sword(w_lv * 65 *dj);					
else if (me->query("weapon/pin") == "ê»ÌìÊ®½×")
		init_sword(w_lv * 66 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðÒ»½×")
		init_sword(w_lv * 67 *dj);					
else if (me->query("weapon/pin") == "öÉ½ð¶þ½×")
		init_sword(w_lv * 68 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðÈý½×")
		init_sword(w_lv * 69 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðËÄ½×")
		init_sword(w_lv * 70 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðÎå½×")
		init_sword(w_lv * 71 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðÁù½×")
		init_sword(w_lv * 72 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðÆß½×")
		init_sword(w_lv * 73 *dj);					
else if (me->query("weapon/pin") == "öÉ½ð°Ë½×")
		init_sword(w_lv * 74 *dj);					
else if (me->query("weapon/pin") == "öÉ½ð¾Å½×")
		init_sword(w_lv * 75 *dj);					
else if (me->query("weapon/pin") == "öÉ½ðÊ®½×")
		init_sword(w_lv * 76 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÒ»½×")
		init_sword(w_lv * 77 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þ½×")
		init_sword(w_lv * 78 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÈý½×")
		init_sword(w_lv * 79 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇËÄ½×")
		init_sword(w_lv * 80 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÎå½×")
		init_sword(w_lv * 81 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÁù½×")
		init_sword(w_lv * 82 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÆß½×")
		init_sword(w_lv * 83 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ°Ë½×")
		init_sword(w_lv * 84 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¾Å½×")
		init_sword(w_lv * 85 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®½×")
		init_sword(w_lv * 86 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®Ò»½×")
		init_sword(w_lv * 87 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®¶þ½×")
		init_sword(w_lv * 88 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®Èý½×")
		init_sword(w_lv * 89 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®ËÄ½×")
		init_sword(w_lv * 90 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®Îå½×")
		init_sword(w_lv * 91 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®Áù½×")
		init_sword(w_lv * 92 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®Æß½×")
		init_sword(w_lv * 93 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®°Ë½×")
		init_sword(w_lv * 94 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇÊ®¾Å½×")
		init_sword(w_lv * 95 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®½×")
		init_sword(w_lv * 96 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®Ò»½×")
		init_sword(w_lv * 97 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®¶þ½×")
		init_sword(w_lv * 98 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®Èý½×")
		init_sword(w_lv * 99 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®ËÄ½×")
		init_sword(w_lv * 100 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®Îå½×")
		init_sword(w_lv * 101 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®Áù½×")
		init_sword(w_lv * 102 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®Æß½×")
		init_sword(w_lv * 103 *dj);					
else if (me->query("weapon/pin") == "¹ÂÐÇ¶þÊ®°Ë½×")
		init_sword(w_lv * 104 *dj);					
			

	
	setup();
}



int do_duanlian(object weapon,object me)
{
	object obj;
	int w_zhi, w_level;
	string w_or;
	string arg;
		me=this_player();

obj=present("xueye", me);//¶É¶É¼ÓÈë¶ÍÔì±øÆ÷ÏµÍ³

	if( !weapon )
		return notify_fail("ÄãÒª¶ÍÁ¶Ê²Ã´?\n");

	if (me->is_fighting())
		return notify_fail("Äã´ò×ÅÄØ?\n");

	if (me->is_busy())
		return notify_fail("ÄãÃ¦×ÅÄØ?\n");

	if( (int)me->query("max_neili") < 10 )
		return notify_fail("ÄãµÄÄÚÁ¦²»¹»£¬ÎÞ·¨¶ÍÁ¶½£Æø£¡\n");

	if( (int)me->query("max_neili") < 500 )
		return notify_fail("ÄãµÄÄÚÁ¦²»¹»£¬ÎÞ·¨¶ÍÁ¶±øÆ÷£¡\n");

	if (userp(me) && !me->query_skill_mapped("force"))
		return notify_fail("ÄãÃ»ÓÐÄÚ¹¦£¬ÔÚÊ¹ÓÃÖÐ°¡!\n");
		
	if(!present("xueye", me))
		return notify_fail("ÄãµÄÉíÉÏÃ»ÓÐÊ÷¾«Ö®Ñª»òÕßÊýÁ¿²»×ã²»×ã5£¡\n");
		
	if(!present("xueye", me)&& obj->query_amount()<5)
		return notify_fail("ÄãµÄÉíÉÏÃ»ÓÐÊ÷¾«Ö®Ñª»òÕßÊýÁ¿²»×ã5£¡\n");
		
	if ( obj->query_amount()<5)
		return notify_fail("ÄãµÄÉíÉÏÃ»ÓÐÊ÷¾«Ö®Ñª»òÕßÊýÁ¿²»×ã5£¡\n");
		
	if( me->query_skill("shenzhao-jing", 1) > 100
            && (int)me->query("max_neili") < 5000 )
		return notify_fail("ÄãµÄÄÚÁ¦²»¹»£¬ÎÞ·¨¶ÍÁ¶±øÆ÷£¡\n");

	if( (int)me->query("qi") < 150 )
		return notify_fail("ÄãµÄÆø²»¹»£¬ÎÞ·¨¶ÍÁ¶½£Æø£¡\n");

	if( (int)me->query("eff_qi") < 30 )
		return notify_fail("ÄãÏÖÔÚµÄÌåÁ¦Ì«Èõ£¬ÎÞ·¨¶ÍÁ¶½£Æø£¡\n");

	if( (int)me->query("eff_jing") < 10 )
		return notify_fail("ÄãÏÖÔÚµÄ¾«Á¦ÎÞ·¨¼¯ÖÐ£¬²»ÄÜ¶ÍÁ¶½£Æø£¡\n");


	message_vision(HIR "$N×óÊÖÖ±Ö¸½£¼¹£¬ÓÒÊÖÊÖÎÕÊ÷¾«ÑªÒº½«ÆäÒ»Ë¿Ë¿µÄ´«ÁË½øÈ¥¡£\n" NOR, me);

	me->add("qi",-150);
	me->add("eff_qi",-30);
	me->add("jing",-30);
	me->add("eff_jing",-30);
	me->add("weapon_max",5);
	me->add("weapon/lv",5);
		obj->add_amount(-5);

		message_vision(HIY "½£ÉíºöµÄÒ»ÁÁ£¬Ò»µÀ½ð¹âÒþÈë$NµÄ½£Ìå£¬²»¼ûÁË£¡\n" NOR,me);
		message_vision(HIG "$NµÄ½£µÄµÈ¼¶Ìá¸ßÁË£¡\n" NOR, me);
	message_vision(HIC "$NµÄ½£ÆøÌáÉýÁË!\n" NOR, me);
		message("vision",ZJCHANNEL+ HIC"Á¶"HIM"Æ÷"HIW"£º"HIC""+me->query("name")+"("+me->query("id")+")½«Ê÷¾«Ö®Ñªµ¼ÈëÎäÆ÷Ö®ÖÐ£¬ÎäÆ÷µÈ¼¶µÃµ½ÌáÉý£¡\n" NOR, users());		

	return 1;
}


int do_hui(object weapon)
{
	string w_name;
	object me,ob;
	me=this_player();
	w_name=me->query("weapon/name");
	if( !weapon )
		return notify_fail("ÄãÒª´Ý»ÙÊ²Ã´?\n");
	message_vision(HIR "$N´óºÈÒ»Éù£¬Ò»ÕÆÇæ½££¬Ò»ÕÆÃÍÁ¦»÷ÏÂ¡£½á¹ûºäÂ¡Ò»Éù¾ÞÏì"
			+w_name+HIR"¶ÏÎªÁ½½Ø!\n" NOR,me);
	me->set("weapon/make",0);
	destruct( this_object() );
	me->delete("weapon");

	me->save();

	return 1;
}
/*void owner_is_killed()
{
        write(HIY"Ö»¼ûÒ»ÉùÇå´àµÄÏìÉù£¬"+query("name")+HIY"ÂäÔÚµØÉÏ£¬¶Ï³ÉÊý½Ø¡£\n"NOR);
        this_object()->unequip();
        this_object()->reset_action();
        this_object()->set("name", query("name") + "µÄËéÆ¬");
        this_object()->set("value", 0);
        this_object()->set("weapon_prop", 0);
}*/
